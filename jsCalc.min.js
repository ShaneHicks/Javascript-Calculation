(()=>{"use strict";let e=[",","."," "],t=[".",","],n={},a={},l={rgx:"sum\\({([^}]+)}\\)",exec:function(e,t,n,a){let l=0;return t.forEach(e=>{let t=parseFloat(f($(`[name="${e}"]`,a).val()));isNaN(t)||(l+=t)}),l}},c={rgx:"avg\\({([^}]+)}\\)",exec:function(e,t,n,a){let l=0,c=0;return t.forEach(e=>{let t=parseFloat(f($(`[name="${e}"]`,a).val()));!isNaN(t)&&(l+=t,c++)}),c>0?l/c:0}},o={rgx:"min\\({([^}]+)}\\)",exec:function(e,t,n,a){let l=t.map(e=>parseFloat(f($(`[name="${e}"]`,a).val())));return Math.min(...l)}},i={rgx:"max\\({([^}]+)}\\)",exec:function(e,t,n,a){let l=t.map(e=>parseFloat(f($(`[name="${e}"]`,a).val())));return Math.max(...l)}},s={rgx:"count\\({([^}]+)}\\)",exec:function(e,t,n,a){return t.length}},u={rgx:"countNotEmpty\\({([^}]+)}\\)",exec:function(e,t,n,a){let l=t.filter(e=>""!==$(`[name="${e}"]`,a).val().trim());return l.length}};function f(n){return n=(n=(n=n.replace(/\s/g,"")).replace(e.join("|"),"")).replace(t.join("|"),".")}function h(e,t,n,a,l,c,o){let i=e;t.forEach(e=>{let t=`[name="${e}"]`,n=f($(t,a).val(),l);i=i.replace(RegExp(`{${e}}`,"g"),n)}),(i=i.replace(/ /g,"")).includes(",")&&(i=i.replace(/,/g,""));let s=g(i,l,c,o),u=x(s,l);n.val(u);{let h=n.data("current");void 0!==h&&h===u?n.trigger("change"):n.data("current",u)}}function g(e,t,n,a){let l=[],c=0;for(;c<e.length;){let o=e.charAt(c);if(o.match(/\d/)){let i=c;for(;o.match(/\d/);)c++,o=e.charAt(c);let s=parseFloat(e.substring(i,c));l.push(s)}else if(o.match(/[-+*/]/))l.push(o),c++;else if("("===o){c++;let u=g(e.substring(c),t,n,a);l.push(u.result),c+=u.offset}else if(")"===o){c++;break}else throw Error("Parsing error: unrecognized character")}return{result:m(l,t,n,a),offset:c}}function m(e,t,n,a){let l={"+":{precedence:10,assoc:"L",exec:(e,t)=>e+t},"-":{precedence:10,assoc:"L",exec:(e,t)=>e-t},"*":{precedence:20,assoc:"L",exec:(e,t)=>e*t},"/":{precedence:20,assoc:"L",exec:(e,t)=>e/t}},c=[],o=[];for(let i=0;i<e.length;i++){let s=e[i];if("number"==typeof s)o.push(s);else if(s in l){for(;c.length>0&&(c[c.length-1]in l)&&("L"===l[s].assoc&&l[s].precedence<=l[c[c.length-1]].precedence||"R"===l[s].assoc&&l[s].precedence<l[c[c.length-1]].precedence);)o.push(c.pop());c.push(s)}}for(;c.length>0;)o.push(c.pop());let u=[];for(let f=0;f<o.length;f++){let h=o[f];if("number"==typeof h)u.push(h);else if(h in l){let g=u.pop(),m=u.pop();u.push(l[h].exec(m,g))}}return u[0]}function x(e,t){let n=e.toFixed(t.decimalPlaces);return t.thousandOpts.includes(",")&&(n=n.replace(/\B(?=(\d{3})+(?!\d))/g,t.thousandOpts[0])),t.decimalOpts.includes(",")&&(n=n.replace(".",t.decimalOpts[0])),n}function v(e,t,n,a){let l=t.attribute,c=this;$(`[${l}]:not([${d}])`,c).each(function(){let e=$(this),o=e.attr(l),i=y(o);if(0!==i.length){for(let s=0;s<i.length;s++){let u=i[s];if(0===s)$(`[name="${u.fieldName}"]`,c).on(p,{equation:o,equationFields:i,result:e,context:c,opts:t,vars:n,funcs:a},function(e){h(e.data.equation,e.data.equationFields,e.data.result,e.data.context,e.data.opts,e.data.vars,e.data.funcs)});else{let f=`[name="${u.fieldName}"]`;if(0===$(f,c).length)return}}e.attr("readonly","readonly"),e.attr(d,d),$(`[name="${i[0].fieldName}"]`,c).trigger("change")}})}function y(e){let t=/{([^}]+)}/gi,n=[],a;for(;null!==(a=t.exec(e));){let l=a[1];n.push({eqName:l,fieldName:l,reactive:!0})}return n}function _(e){let t=this;$(`[${e}][${d}]`,t).each(function(){let n=$(this),a=n.attr(e),l=y(a);if(0!==l.length){for(let c=0;c<l.length;c++){let o=l[c];$(`[name="${o.fieldName}"]`,t).off(".jautocalc")}n.removeAttr("readonly"),n.removeAttr(d)}})}n.sum=l,n.avg=c,n.min=o,n.max=i,n.count=s,n.countNotEmpty=u,r().fn.jAutoCalc=function(){let e="init",t=r().extend({},r().fn.jAutoCalc.defaults),n={},a={};for(let l=0;l<arguments.length;l++){let c=arguments[l];"string"==typeof c?e=c.toString():"object"==typeof c&&(t=r().extend(t,c))}let o={init:v,destroy:_};o[e]?o[e].apply(this,[t,a,n]):v.apply(this,[t,a,n])},r().fn.jAutoCalc.defaults={attribute:"jAutoCalc",thousandOpts:[",","."," "],decimalOpts:[".",","],decimalPlaces:-1,initFire:!0,chainFire:!0,keyEventsFire:!1,readOnlyResults:!0,showParseError:!0,emptyAsZero:!1,smartIntegers:!1,onShowResult:null,funcs:n,vars:a}})();
